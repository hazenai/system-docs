<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Basic Installation - Deployment Documentation</title>
  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Basic Installation";
    var mkdocs_page_input_path = "installation.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Deployment Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Config Documentation</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Basic Installation</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#basic-installation-guide-for-trajectory-and-sbmp-system-deployment">Basic Installation Guide for Trajectory and SBMP System Deployment</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#prerequisites">Prerequisites</a></li>
        
            <li><a class="toctree-l3" href="#edge-script-installtion">Edge Script Installtion</a></li>
        
            <li><a class="toctree-l3" href="#running-the-edge-script">Running the Edge Script</a></li>
        
            <li><a class="toctree-l3" href="#running-the-services-trajectory-configuration">Running the services (Trajectory Configuration)</a></li>
        
            <li><a class="toctree-l3" href="#running-the-services-sbmp-configuration">Running the services (SBMP Configuration)</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../site-rules-specs/">Site Rules Specification</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../flash/">Flashing Instructions</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../camera-calibration/">Camera Calibration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../utilities/">Utilities</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Deployment Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Basic Installation</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="basic-installation-guide-for-trajectory-and-sbmp-system-deployment">Basic Installation Guide for Trajectory and SBMP System Deployment</h1>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Edge device is flashed with Nvidia <code>JetPack 4.4.0</code> (Make sure Jetson SDK Components are also installed)</li>
<li>Internet</li>
<li>Storage (at least 32GB)</li>
</ul>
<h2 id="edge-script-installtion">Edge Script Installtion</h2>
<ul>
<li>Power Up your edge device and connect keyboard, mouse, monitor etc.</li>
<li>Open terminal <code>CTRL + ALT + T</code>.</li>
<li>Check if <code>python3</code> is installed on device <code>python3 --version</code>. If not <a href="https://phoenixnap.com/kb/how-to-install-python-3-ubuntu">follow this link to install</a></li>
<li>Check if docker is installed and running <code>sudo docker info</code>. If docker is running, make sure it's <code>Server Version</code> is <code>19.03.6</code></li>
<li>Add current user to <code>docker</code> group and then reboot</li>
</ul>
<pre><code class="bash">sudo usermod -aG docker $USER
sudo reboot
</code></pre>

<ul>
<li>Check if nvidia-container-runtime is installed <code>nvidia-container-runtime --version</code>. If it's not installed, then install</li>
</ul>
<pre><code class="bash"># Add the package repositories
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
# nvidia-container-runtime installation
sudo apt-get update &amp;&amp; sudo apt-get install -y nvidia-container-toolkit nvidia-container-runtime
sudo systemctl restart docker
</code></pre>

<ul>
<li>Download Edge Scripts <code>wget GET_LINK_FROM_ABDULLAH</code></li>
<li>Uncompress the downloaded file <code>tar -xvzf AutoDeployment-1.4.0.tar.gz</code></li>
<li>Change directory <code>cd AutoDeployment-1.4.0/edge/</code>. Check if <code>install.py</code> and <code>dependencies.yaml</code> is present.</li>
</ul>
<h2 id="running-the-edge-script">Running the Edge Script</h2>
<ul>
<li>RUN the install script <code>sudo python3 install.py -d -p</code>. <code>-d</code> flag will install system dependencies like <code>docker, docker-compose</code> and <code>-p</code> flag will set power mode on jetson devices.</li>
<li>Now, answer the questions asked in command line.</li>
<li>Select storage disk. Choose SD card</li>
</ul>
<pre><code class="bash">NAME         SIZE      MOUNTPOINT       UUID
mmcblk0p1    14G       /                eda65433-df7c-4de9-8c4b-9ab2865b4f24
mmcblk1p1    234.7G    /media/sdcard    a10a85fe-a451-dd4c-b3b0-6862eb17eb56

Choose which disk to use for deployment[1-2]: 2

</code></pre>

<ul>
<li>Select problem type</li>
</ul>
<pre><code class="bash">Select the problem you want to deploy:
0: Video Light Phase Detection
1: SeatBelt/MobilePhone
2: Trajectory
[0-2]: 1

</code></pre>

<ul>
<li>Type your company name</li>
</ul>
<pre><code class="bash">Please enter your company's name: hazenclient

</code></pre>

<ul>
<li>Select Power mode on Jetson devices. choose with id=2</li>
</ul>
<pre><code class="bash">################ Collecting Hardware Info #######################
## Power Model Selection on Jetson Devices ##
ID=0 NAME=MODE_15W_2CORE
ID=1 NAME=MODE_15W_4CORE
ID=2 NAME=MODE_15W_6CORE
ID=3 NAME=MODE_10W_2CORE
ID=4 NAME=MODE_10W_4CORE

Select Power Model. ID: 2

</code></pre>

<ul>
<li>Now, script will start installing system dependencies.</li>
<li>After system dependencies installation, script will install required services. This process may take <code>20-30 mins</code>.</li>
</ul>
<h2 id="running-the-services-trajectory-configuration">Running the services (Trajectory Configuration)</h2>
<ul>
<li>Move to following directory <code>cd $SD_CARD_MOUNTPOINT/hazen-test/imagetars/$COMPANY_NAME/</code>. For example, in this case, I will move to
<code>cd /media/sdcard/hazen-test/imagetars/hazenclient/</code></li>
<li>Run the following command <code>sudo cp -r ./traj/* ./</code></li>
</ul>
<h3 id="config-changes-in-image-cache">Config Changes in Image Cache</h3>
<ul>
<li>Open <code>image_cache</code> config. <code>sudo nano service_configs/image_cache/config.yaml</code></li>
<li>If your have a working h264 or h265 encoded rtsp video stream url and want to use that then change <code>cam_id</code> key in <code>service_configs/image_cache/config.yaml</code> to gstreamer pipeline with your rtsp stream as source. For Example:
For H265 encoded stream, following gstreamer pipeline will work (Also note: this pipeline is resizing frames to 1920x1080)</li>
</ul>
<pre><code>cam_id: &quot;rtspsrc location=&lt;rtsp_url&gt; latency=0 drop-on-latency=true ! rtph265depay ! h265parse ! omxh265dec  disable-dpb=true ! nvvidconv interpolation-method=1 ! video/x-raw, width=1920, height=1080, format=(string)BGRx ! appsink&quot;
</code></pre>

<ul>
<li>If you are using rtsp stream with gstreamer pipeline, update <code>encoder</code> key. Change its value from <code>ffmpeg</code> to <code>gstreamer</code></li>
<li>If you are using rtsp stream, update <code>delay_for_file_ms</code> key. Make its value <code>0</code>. Because rtsp stream has built-in delay between frames. This value is used while running from video files and adding a
delay to adjust the fps.</li>
<li>If you are using jpeg encoding in gstreamer pipeline, then change <code>jpeg_encoding</code> to <code>true</code></li>
<li>save(CTRL+S) changes in image-cache config and exit (CTRL+X)</li>
</ul>
<h3 id="config-changes-in-object-detector">Config Changes in Object Detector</h3>
<ul>
<li>Open <code>object_detector</code> config for changes and update <code>trt_preprocessor_input_dims</code>. This take frames dimensions in following format [height, width, channels]. If you have not resized the frames
in gstreamer pipeline in <code>image_cache</code>, then get frame  dimensions (resolution) from camera settings. If you have resized frame in gstreamer pipeline, use them. In above example, we have resized frames
to 1920x1080, so we will update it [1080, 1920, 3].</li>
<li>If you have enabled jpeg encoding in image cache, change <code>jpeg_encoded</code> to <code>true</code> in od config as well.</li>
<li>Save and exit od config.</li>
</ul>
<h3 id="config-changes-in-image-cache-alpr">Config Changes in Image Cache Alpr</h3>
<ul>
<li>Open <code>image_cache_alpr</code> config. <code>sudo nano service_configs/image_cache_alpr/config.yaml</code></li>
<li>Update <code>cam_id</code>. Use H265 or H264 encoding pipeline depending on your camera settings. But here resize to <code>2560x1440</code></li>
<li>Update <code>encoder</code> key</li>
<li>Update <code>delay_for_file_ms</code> key</li>
<li>Keep <code>jpeg_encoding</code> to <code>false</code> here. Also dont use jpeg encoding in gstreamer pipeline here.</li>
<li>Save and Exit.</li>
</ul>
<h3 id="config-changes-in-violation-service">Config Changes in Violation Service</h3>
<ul>
<li>Configure Violation regions and rules</li>
<li>Now, Run the services <code>sudo ./run-services.sh</code></li>
</ul>
<h3 id="check-your-site-id">Check your SITE ID</h3>
<ul>
<li>To check your site id, do <code>cat .env</code> and copy <code>SITE_ID</code></li>
</ul>
<h2 id="running-the-services-sbmp-configuration">Running the services (SBMP Configuration)</h2>
<ul>
<li>Move to following directory <code>cd $SD_CARD_MOUNTPOINT/hazen-test/imagetars/$COMPANY_NAME/</code>. For example, in this case, I will move to
<code>cd /media/sdcard/hazen-test/imagetars/hazenclient/</code></li>
<li>Run the following command <code>sudo cp -r ./sbmp/* ./</code></li>
</ul>
<h3 id="config-changes-in-image-cache_1">Config Changes in Image Cache</h3>
<ul>
<li>Open <code>image_cache</code> config. <code>sudo nano service_configs/image_cache/config.yaml</code></li>
<li>If your have a working h264 or h265 encoded rtsp video stream url and want to use that then change <code>cam_id</code> key in <code>service_configs/image_cache/config.yaml</code> to gstreamer pipeline with your rtsp stream as source. For Example:
For H265 encoded stream, following gstreamer pipeline will work (Also note: this pipeline is resizing frames to 2560x1440)</li>
</ul>
<pre><code>cam_id: &quot;rtspsrc location=&lt;rtsp_url&gt; latency=0 drop-on-latency=true ! rtph265depay ! h265parse ! omxh265dec  disable-dpb=true ! nvvidconv interpolation-method=1 ! video/x-raw, width=2560, height=1440, format=(string)BGRx ! appsink&quot;
</code></pre>

<ul>
<li>If you are using rtsp stream with gstreamer pipeline, update <code>encoder</code> key. Change its value from <code>ffmpeg</code> to <code>gstreamer</code></li>
<li>If you are using rtsp stream, update <code>delay_for_file_ms</code> key. Make its value <code>0</code>. Because rtsp stream has built-in delay between frames. This value is used while running from video files and adding a
delay to adjust the fps.</li>
<li>If you are using jpeg encoding in gstreamer pipeline, then change <code>jpeg_encoding</code> to <code>true</code></li>
<li>save(CTRL+S) changes in image-cache config and exit (CTRL+X)</li>
</ul>
<h3 id="config-changes-in-object-detector_1">Config Changes in Object Detector</h3>
<ul>
<li>Open <code>object_detector</code> config for changes and update <code>trt_preprocessor_input_dims</code>. This take frames dimensions in following format [height, width, channels]. If you have not resized the frames
in gstreamer pipeline in <code>image_cache</code>, then get frame  dimensions (resolution) from camera settings. If you have resized frame in gstreamer pipeline, use them. In above example, we have resized frames 
to 2560x1440, so we will update it [1440, 2560, 3].</li>
<li>If you have enabled jpeg encoding in image cache, change <code>jpeg_encoded</code> to <code>true</code> in od config as well</li>
<li>Save and exit od config</li>
</ul>
<h3 id="config-changes-in-violation-service_1">Config Changes in Violation Service</h3>
<ul>
<li>Configure Violation regions and rules</li>
<li>Now, Run the services <code>sudo ./run-services.sh</code></li>
</ul>
<h3 id="check-your-site-id_1">Check your SITE ID</h3>
<ul>
<li>To check your site id, do <code>cat .env</code> and copy <code>SITE_ID</code></li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../site-rules-specs/" class="btn btn-neutral float-right" title="Site Rules Specification">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Config Documentation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../site-rules-specs/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
